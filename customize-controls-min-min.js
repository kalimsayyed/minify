(function(e,f){var d=wp.customize;d.Setting=d.Value.extend({initialize:function(a,b,h){var c;d.Value.prototype.initialize.call(this,b,h);this.id=a;this.transport=this.transport||"refresh";this.bind(this.preview)},preview:function(){switch(this.transport){case"refresh":return this.previewer.refresh();case"postMessage":return this.previewer.send("setting",[this.id,this()])}}});d.Control=d.Class.extend({initialize:function(a,k){var c=this,l,b,j;this.params={};f.extend(this,k||{});this.id=a;this.selector="#customize-control-"+a.replace("]","").replace("[","-");this.container=f(this.selector);j=f.map(this.params.settings,function(g){return g});d.apply(d,j.concat(function(){var g;c.settings={};for(g in c.params.settings){c.settings[g]=d(c.params.settings[g])}c.setting=c.settings["default"]||null;c.ready()}));c.elements=[];l=this.container.find("[data-customize-setting-link]");b={};l.each(function(){var g=f(this),h;if(g.is(":radio")){h=g.prop("name");if(b[h]){return}b[h]=true;g=l.filter('[name="'+h+'"]')}d(g.data("customizeSettingLink"),function(i){var n=new d.Element(g);c.elements.push(n);n.sync(i);n.set(i())})})},ready:function(){},dropdownInit:function(){var c=this,i=this.container.find(".dropdown-status"),b=this.params,a=function(g){if(typeof g==="string"&&b.statuses&&b.statuses[g]){i.html(b.statuses[g]).show()}else{i.hide()}};var j=false;this.container.on("click keydown",".dropdown",function(g){if(g.type==="keydown"&&13!==g.which){return}g.preventDefault();if(!j){c.container.toggleClass("open")}if(c.container.hasClass("open")){c.container.parent().parent().find("li.library-selected").focus()}j=true;setTimeout(function(){j=false},400)});this.setting.bind(a);a(this.setting())}});d.ColorControl=d.Control.extend({ready:function(){var a=this,b=this.container.find(".color-picker-hex");b.val(a.setting()).wpColorPicker({change:function(c,h){a.setting.set(b.wpColorPicker("color"))},clear:function(){a.setting.set(false)}})}});d.UploadControl=d.Control.extend({ready:function(){var a=this;this.params.removed=this.params.removed||"";this.success=f.proxy(this.success,this);this.uploader=f.extend({container:this.container,browser:this.container.find(".upload"),dropzone:this.container.find(".upload-dropzone"),success:this.success,plupload:{},params:{}},this.uploader||{});if(a.params.extensions){a.uploader.plupload.filters=[{title:d.l10n.allowedFiles,extensions:a.params.extensions}]}if(a.params.context){a.uploader.params["post_data[context]"]=this.params.context}if(d.settings.theme.stylesheet){a.uploader.params["post_data[theme]"]=d.settings.theme.stylesheet}this.uploader=new wp.Uploader(this.uploader);this.remover=this.container.find(".remove");this.remover.on("click keydown",function(b){if(b.type==="keydown"&&13!==b.which){return}a.setting.set(a.params.removed);b.preventDefault()});this.removerVisibility=f.proxy(this.removerVisibility,this);this.setting.bind(this.removerVisibility);this.removerVisibility(this.setting.get())},success:function(a){this.setting.set(a.get("url"))},removerVisibility:function(a){this.remover.toggle(a!=this.params.removed)}});d.ImageControl=d.UploadControl.extend({ready:function(){var a=this,b;this.uploader={init:function(j){var c,i;if(this.supports.dragdrop){return}c=a.container.find(".upload-fallback");i=c.children().detach();this.browser.detach().empty().append(i);c.append(this.browser).show()}};d.UploadControl.prototype.ready.call(this);this.thumbnail=this.container.find(".preview-thumbnail img");this.thumbnailSrc=f.proxy(this.thumbnailSrc,this);this.setting.bind(this.thumbnailSrc);this.library=this.container.find(".library");this.tabs={};b=this.library.find(".library-content");this.library.children("ul").children("li").each(function(){var i=f(this),c=i.data("customizeTab"),j=b.filter('[data-customize-tab="'+c+'"]');a.tabs[c]={both:i.add(j),link:i,panel:j}});this.library.children("ul").on("click keydown","li",function(i){if(i.type==="keydown"&&13!==i.which){return}var c=f(this).data("customizeTab"),j=a.tabs[c];i.preventDefault();if(j.link.hasClass("library-selected")){return}a.selected.both.removeClass("library-selected");a.selected=j;a.selected.both.addClass("library-selected")});this.library.on("click keydown","a",function(h){if(h.type==="keydown"&&13!==h.which){return}var c=f(this).data("customizeImageValue");if(c){a.setting.set(c);h.preventDefault()}});if(this.tabs.uploaded){this.tabs.uploaded.target=this.library.find(".uploaded-target");if(!this.tabs.uploaded.panel.find(".thumbnail").length){this.tabs.uploaded.both.addClass("hidden")}}b.each(function(){var c=a.tabs[f(this).data("customizeTab")];if(!c.link.hasClass("hidden")){a.selected=c;c.both.addClass("library-selected");return false}});this.dropdownInit()},success:function(a){d.UploadControl.prototype.success.call(this,a);if(this.tabs.uploaded&&this.tabs.uploaded.target.length){this.tabs.uploaded.both.removeClass("hidden");a.element=f('<a href="#" class="thumbnail"></a>').data("customizeImageValue",a.get("url")).append('<img src="'+a.get("url")+'" />').appendTo(this.tabs.uploaded.target)}},thumbnailSrc:function(a){if(/^(https?:)?\/\//.test(a)){this.thumbnail.prop("src",a).show()}else{this.thumbnail.hide()}}});d.defaultConstructor=d.Setting;d.control=new d.Values({defaultConstructor:d.Control});d.PreviewFrame=d.Messenger.extend({sensitivity:2000,initialize:function(a,b){var c=f.Deferred(),h=this;c.promise(this);this.container=a.container;this.signature=a.signature;f.extend(a,{channel:d.PreviewFrame.uuid()});d.Messenger.prototype.initialize.call(this,a,b);this.add("previewUrl",a.previewUrl);this.query=f.extend(a.query||{},{customize_messenger_channel:this.channel()});this.run(c)},run:function(c){var h=this,b=false,a=false;if(this._ready){this.unbind("ready",this._ready)}this._ready=function(){a=true;if(b){c.resolveWith(h)}};this.bind("ready",this._ready);this.request=f.ajax(this.previewUrl(),{type:"POST",data:this.query,xhrFields:{withCredentials:true}});this.request.fail(function(){c.rejectWith(h,["request failure"])});this.request.done(function(l){var m=h.request.getResponseHeader("Location"),n=h.signature,g;if(m&&m!=h.previewUrl()){c.rejectWith(h,["redirect",m]);return}if("0"===l){h.login(c);return}if("-1"===l){c.rejectWith(h,["cheatin"]);return}g=l.lastIndexOf(n);if(-1===g||g<l.lastIndexOf("</html>")){c.rejectWith(h,["unsigned"]);return}l=l.slice(0,g)+l.slice(g+n.length);h.iframe=f("<iframe />").appendTo(h.container);h.iframe.one("load",function(){b=true;if(a){c.resolveWith(h)}else{setTimeout(function(){c.rejectWith(h,["ready timeout"])},h.sensitivity)}});h.targetWindow(h.iframe[0].contentWindow);h.targetWindow().document.open();h.targetWindow().document.write(l);h.targetWindow().document.close()})},login:function(b){var c=this,a;a=function(){b.rejectWith(c,["logged out"])};if(this.triedLogin){return a()}f.get(d.settings.url.ajax,{action:"logged-in"}).fail(a).done(function(j){var i;if("1"!==j){a()}i=f('<iframe src="'+c.previewUrl()+'" />').hide();i.appendTo(c.container);i.load(function(){c.triedLogin=true;i.remove();c.run(b)})})},destroy:function(){d.Messenger.prototype.destroy.call(this);this.request.abort();if(this.iframe){this.iframe.remove()}delete this.request;delete this.iframe;delete this.targetWindow}});(function(){var a=0;d.PreviewFrame.uuid=function(){return"preview-"+a++}}());d.Previewer=d.Messenger.extend({refreshBuffer:250,initialize:function(a,c){var j=this,b=/^https?/,i;f.extend(this,c||{});this.refresh=(function(n){var m=n.refresh,g=function(){h=null;m.call(n)},h;return function(){if(typeof h!=="number"){if(n.loading){n.abort()}else{return g()}}clearTimeout(h);h=setTimeout(g,n.refreshBuffer)}})(this);this.container=d.ensure(a.container);this.allowedUrls=a.allowedUrls;this.signature=a.signature;a.url=window.location.href;d.Messenger.prototype.initialize.call(this,a);this.add("scheme",this.origin()).link(this.origin).setter(function(g){var h=g.match(b);return h?h[0]:""});this.add("previewUrl",a.previewUrl).setter(function(g){var h;if(/\/wp-admin(\/|$)/.test(g.replace(/[#?].*$/,""))){return null}f.each([g.replace(b,j.scheme()),g],function(m,n){f.each(j.allowedUrls,function(k,l){if(0===n.indexOf(l)){h=n;return false}});if(h){return false}});return h?h:null});this.previewUrl.bind(this.refresh);this.scroll=0;this.bind("scroll",function(g){this.scroll=g});this.bind("url",this.previewUrl)},query:function(){},abort:function(){if(this.loading){this.loading.destroy();delete this.loading}},refresh:function(){var a=this;this.abort();this.loading=new d.PreviewFrame({url:this.url(),previewUrl:this.previewUrl(),query:this.query()||{},container:this.container,signature:this.signature});this.loading.done(function(){this.bind("synced",function(){if(a.preview){a.preview.destroy()}a.preview=this;delete a.loading;a.targetWindow(this.targetWindow());a.channel(this.channel());a.send("active")});this.send("sync",{scroll:a.scroll,settings:d.get()})});this.loading.fail(function(b,c){if("redirect"===b&&c){a.previewUrl(c)}if("logged out"===b){if(a.preview){a.preview.destroy();delete a.preview}a.login().done(a.refresh)}if("cheatin"===b){a.cheatin()}})},login:function(){var a=this,h,b,c;if(this._login){return this._login}h=f.Deferred();this._login=h.promise();b=new d.Messenger({channel:"login",url:d.settings.url.login});c=f('<iframe src="'+d.settings.url.login+'" />').appendTo(this.container);b.targetWindow(c[0].contentWindow);b.bind("login",function(){c.remove();b.destroy();delete a._login;h.resolve()});return this._login},cheatin:function(){f(document.body).empty().addClass("cheatin").append("<p>"+d.l10n.cheatin+"</p>")}});d.controlConstructor={color:d.ColorControl,upload:d.UploadControl,image:d.ImageControl};f(function(){d.settings=window._wpCustomizeSettings;d.l10n=window._wpCustomizeControlsL10n;if(!d.settings){return}if(!f.support.postMessage||(!f.support.cors&&d.settings.isCrossDomain)){return window.location=d.settings.url.fallback}var l=f(document.body),j=l.children(".wp-full-overlay"),b,a,c;f("#customize-controls").on("keydown",function(g){if(f(g.target).is("textarea")){return}if(13===g.which){g.preventDefault()}});a=new d.Previewer({container:"#customize-preview",form:"#customize-controls",previewUrl:d.settings.url.preview,allowedUrls:d.settings.url.allowed,signature:"WP_CUSTOMIZER_SIGNATURE"},{nonce:d.settings.nonce,query:function(){return{wp_customize:"on",theme:d.settings.theme.stylesheet,customized:JSON.stringify(d.get()),nonce:this.nonce.preview}},save:function(){var i=this,g=f.extend(this.query(),{action:"customize_save",nonce:this.nonce.save}),h=f.post(d.settings.url.ajax,g);d.trigger("save",h);l.addClass("saving");h.always(function(){l.removeClass("saving")});h.done(function(n){if("0"===n){i.preview.iframe.hide();i.login().done(function(){i.save();i.preview.iframe.show()});return}if("-1"===n){i.cheatin();return}d.trigger("saved")})}});a.bind("nonce",function(g){f.extend(this.nonce,g)});f.each(d.settings.settings,function(g,h){d.create(g,g,h.value,{transport:h.transport,previewer:a})});f.each(d.settings.controls,function(g,i){var n=d.controlConstructor[i.type]||d.Control,h;h=d.control.add(g,new n(g,{params:i,previewer:a}))});if(a.previewUrl()){a.refresh()}else{a.previewUrl(d.settings.url.home)}(function(){var g=new d.Values(),h=g.create("saved"),i=g.create("activated");g.bind("change",function(){var p=f("#save"),o=f(".back");if(!i()){p.val(d.l10n.activate).prop("disabled",false);o.text(d.l10n.cancel)}else{if(h()){p.val(d.l10n.saved).prop("disabled",true);o.text(d.l10n.close)}else{p.val(d.l10n.save).prop("disabled",false);o.text(d.l10n.cancel)}}});h(true);i(d.settings.theme.active);d.bind("change",function(){g("saved").set(false)});d.bind("saved",function(){g("saved").set(true);g("activated").set(true)});i.bind(function(n){if(n){d.trigger("activated")}});d.state=g}());f(".customize-section-title").bind("click keydown",function(g){if(g.type==="keydown"&&13!==g.which){return}var h=f(this).parents(".customize-section");if(h.hasClass("cannot-expand")){return}if("customize-section-title_tagline"===h.attr("id")){f(".wp-full-overlay-sidebar-content").scrollTop(0)}f(".customize-section").not(h).removeClass("open");h.toggleClass("open");g.preventDefault()});f("#save").click(function(g){a.save();g.preventDefault()}).keydown(function(g){if(9===g.which){return}if(13===g.which){a.save()}g.preventDefault()});f(".back").keydown(function(g){if(9===g.which){return}if(13===g.which){c.send("close")}g.preventDefault()});f(".collapse-sidebar").on("click keydown",function(g){if(g.type==="keydown"&&13!==g.which){return}j.toggleClass("collapsed").toggleClass("expanded");g.preventDefault()});c=new d.Messenger({url:d.settings.url.parent,channel:"loader"});c.bind("back",function(){f(".back").on("click.back",function(g){g.preventDefault();c.send("close")})});d.bind("saved",function(){c.send("saved")});d.bind("activated",function(){if(c.targetWindow()){c.send("activated",d.settings.url.activated)}else{if(d.settings.url.activated){window.location=d.settings.url.activated}}});c.send("ready");f.each({background_image:{controls:["background_repeat","background_position_x","background_attachment"],callback:function(g){return !!g}},show_on_front:{controls:["page_on_front","page_for_posts"],callback:function(g){return"page"===g}},header_textcolor:{controls:["header_textcolor"],callback:function(g){return"blank"!==g}}},function(h,g){d(h,function(i){f.each(g.controls,function(o,p){d.control(p,function(m){var n=function(r){m.container.toggle(g.callback(r))};n(i.get());i.bind(n)})})})});d.control("display_header_text",function(g){var h="";g.elements[0].unsync(d("header_textcolor"));g.element=new d.Element(g.container.find("input"));g.element.set("blank"!==g.setting());g.element.bind(function(i){if(!i){h=d("header_textcolor").get()}g.setting.set(i?h:"blank")});g.setting.bind(function(i){g.element.set("blank"!==i)})});d.control("header_image",function(g){g.setting.bind(function(h){if(h===g.params.removed){g.settings.data.set(false)}});g.library.on("click","a",function(h){g.settings.data.set(f(this).data("customizeHeaderImageData"))});g.uploader.success=function(h){var i;d.ImageControl.prototype.success.call(g,h);i={attachment_id:h.get("id"),url:h.get("url"),thumbnail_url:h.get("url"),height:h.get("height"),width:h.get("width")};h.element.data("customizeHeaderImageData",i);g.settings.data.set(i)}});d.trigger("ready");var k=f(".back");k.focus();setTimeout(function(){k.focus()},200)})})(wp,jQuery);